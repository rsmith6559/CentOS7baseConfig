---

# update everything play

- name: update everything but the kernel
  yum:
    name: '*'
    state: latest
    exclude: kernel
  register: updates

- name: check for a kernel update?
  yum:
    list: updates
    update_only: yes
  register: kernel_update

- block:
  - name: update kernel
    yum:
      name: kernel
      state: latest
    notify: reboot
  when: kernel_update.results != []

- block:
  - name: write swinv to ansible controller
    shell:
      cmd: rpm -qa > ~/{{ ansible_facts.hostname }}
      warn: false

  - fetch:
      src: ~/{{ ansible_facts.hostname }}
      dest: "/home/swinv/{{ ansible_distribution_major_version }}/"
      flat: yes

  - file:
      path: ~/{{ ansible_facts.hostname | quote }}
      state: absent
  when: updates.changed == true or kernel_update.results != []

...

